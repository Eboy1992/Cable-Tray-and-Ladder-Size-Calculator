<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cable Tray Visualizer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f3f3f3; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    svg { border: 2px solid #000; background: #fff; display: block; margin-top: 20px; }
    .legend span { display: inline-block; width: 14px; height: 14px; border-radius: 50%; margin-right: 5px; }
    .blue { background: #4A90E2; }
    .green { background: #4CAF50; }
    #fillInfo { font-weight: bold; margin-top: 10px; }
    #warning {
      background: #ffe5e5;
      border: 1px solid #ff0000;
      color: #b30000;
      padding: 10px;
      margin-top: 10px;
      font-weight: bold;
      display: none;
    }
  </style>
</head>
<body>

<h2>Tray Settings</h2>
<label>Tray Width (mm): <input type="number" id="trayWidth" value="600" onchange="drawTray()" /></label>
<label>Tray Depth (mm): <input type="number" id="trayDepth" value="150" onchange="drawTray()" /></label>
<label>Tray Type:
  <select id="trayType" onchange="drawTray()">
    <option>Ladder</option>
    <option>Perforated</option>
    <option>Solid Bottom</option>
  </select>
</label>
<label>Fill Ratio:
  <select id="fillRatio" onchange="drawTray()">
    <option value="0.4">40%</option>
    <option value="0.5">50%</option>
    <option value="0.6">60%</option>
    <option value="1">100%</option>
  </select>
</label>

<h2>Cable Inputs</h2>
<table id="cableTable">
  <thead>
    <tr><th>#</th><th>Type</th><th>Line Size</th><th>Qty</th><th>Ground Size</th><th>Qty</th></tr>
  </thead>
  <tbody></tbody>
</table>
<button onclick="addCableRow()">+ Add Cable</button>
<div id="warning"></div>

<h2>Tray Visualizer</h2>
<svg id="traySvg"></svg>
<div id="fillInfo"></div>
<div class="legend">
  <span class="blue"></span> Line
  <span class="green" style="margin-left:20px;"></span> Ground
</div>

<script>
function getSizes(type) {
  const baseSingle = [
    { label: "12 AWG", diameter: 3 },
    { label: "10 AWG", diameter: 3.5 },
    { label: "8 AWG", diameter: 4.5 },
    { label: "6 AWG", diameter: 5.5 },
    { label: "4 AWG", diameter: 6.5 },
    { label: "2 AWG", diameter: 8 },
    { label: "1/0 AWG", diameter: 10 },
    { label: "250 kcmil", diameter: 15 },
    { label: "500 kcmil", diameter: 20 },
    { label: "1000 kcmil", diameter: 30 }
  ];
  const baseMulti = [
    { label: "2C 5.5mm¬≤", diameter: 12 },
    { label: "3C 5.5mm¬≤", diameter: 14 },
    { label: "4C 14mm¬≤", diameter: 17 },
    { label: "4C 60mm¬≤", diameter: 26 }
  ];
  const base = type === "Single Core" ? baseSingle : baseMulti;
  return base.map(c => ({
    ...c,
    area: +(Math.PI * (c.diameter / 2) ** 2).toFixed(2)
  }));
}

function updateDropdowns(selectEl) {
  const row = selectEl.closest("tr");
  const type = selectEl.value;
  row.querySelector(".lineSize").innerHTML = getSizes(type).map((s, i) => `<option value="${i}">${s.label}</option>`).join('');
  row.querySelector(".groundSize").innerHTML = getSizes("Single Core").map((s, i) => `<option value="${i}">${s.label}</option>`).join('');
}

function addCableRow() {
  const tbody = document.querySelector("#cableTable tbody");
  const index = tbody.rows.length + 1;
  const row = document.createElement("tr");
  row.innerHTML = `
    <td>${index}</td>
    <td><select onchange="updateDropdowns(this); drawTray()"><option>Single Core</option><option>Multicore</option></select></td>
    <td><select class="lineSize"></select></td>
    <td><input type="number" min="0" value="1" /></td>
    <td><select class="groundSize"></select></td>
    <td><input type="number" min="0" value="0" /></td>
  `;
  tbody.appendChild(row);
  updateDropdowns(row.querySelector("select"));
  row.querySelectorAll("select, input").forEach(el => el.addEventListener("change", drawTray));
  drawTray();
}

function drawTray() {
  const trayW = +document.getElementById("trayWidth").value;
  const trayH = +document.getElementById("trayDepth").value;
  const fillRatio = +document.getElementById("fillRatio").value;
  const trayType = document.getElementById("trayType").value;

  const rungHeight = trayType === "Ladder" ? 20 : 0;
  const usableH = trayH - rungHeight;
  const fillLimit = trayW * usableH * fillRatio;

  const svg = document.getElementById("traySvg");
  svg.setAttribute("viewBox", `0 0 ${trayW} ${trayH}`);
  svg.setAttribute("width", trayW);
  svg.setAttribute("height", trayH);
  svg.innerHTML = `<rect x="0" y="0" width="${trayW}" height="${trayH}" fill="#fff" stroke="#000"/>`;
  if (trayType === "Ladder") {
    svg.innerHTML += `<rect x="0" y="${trayH - rungHeight}" width="${trayW}" height="${rungHeight}" fill="#bbb" opacity="0.5"/>`;
  }

  const cables = [];
  document.querySelectorAll("#cableTable tbody tr").forEach(row => {
    const type = row.cells[1].querySelector("select").value;
    const lineIdx = +row.cells[2].querySelector("select").value;
    const lineQty = +row.cells[3].querySelector("input").value;
    const groundIdx = +row.cells[4].querySelector("select").value;
    const groundQty = +row.cells[5].querySelector("input").value;
    const line = getSizes(type)[lineIdx];
    const ground = getSizes("Single Core")[groundIdx];
    for (let i = 0; i < lineQty; i++) cables.push({ ...line, color: "#4A90E2" });
    for (let i = 0; i < groundQty; i++) cables.push({ ...ground, color: "#4CAF50" });
  });

  let usedArea = 0;
  let placed = 0;
  let spacing = 2;
  let padding = 4;

  let rowY = trayH - rungHeight;
  let maxRowHeight = 0;
  let rowCables = [];

  let warningShown = false;

  for (let i = 0; i < cables.length; i++) {
    const c = cables[i];
    const r = c.diameter / 2;
    const d = c.diameter;

    const rowWidth = rowCables.reduce((sum, ci) => sum + ci.diameter + spacing, -spacing) + d;

    if (rowWidth > trayW - padding * 2) {
      rowY -= maxRowHeight + spacing;
      if (rowY - d < 0) {
        warningShown = true;
        break;
      }
      rowCables = [];
      maxRowHeight = d;
    } else {
      maxRowHeight = Math.max(maxRowHeight, d);
    }

    if (usedArea + c.area > fillLimit) {
      warningShown = true;
      break;
    }

    const cx = padding + rowCables.reduce((sum, ci) => sum + ci.diameter + spacing, 0) + r;
    const cy = rowY - r;

    svg.innerHTML += `<circle cx="${cx}" cy="${cy}" r="${r}" stroke="${c.color}" stroke-width="2" fill="none"/>`;
    svg.innerHTML += `<circle cx="${cx}" cy="${cy}" r="${r / 2.5}" fill="#cd7f32"/>`;

    usedArea += c.area;
    placed++;
    rowCables.push(c);
  }

  document.getElementById("fillInfo").textContent =
    `‚úÖ Placed ${placed} cables ‚Äî Used ${usedArea.toFixed(0)} mm¬≤ of ${fillLimit.toFixed(0)} mm¬≤ (${(usedArea / (trayW * usableH) * 100).toFixed(1)}%)`;

  const warningBox = document.getElementById("warning");
  warningBox.style.display = warningShown ? "block" : "none";
  warningBox.innerHTML = warningShown ? `
    ‚ö†Ô∏è Cable tray is full. Additional cables were not placed.<br>
    üëâ Please <strong>increase the tray size</strong> or <strong>reduce the number/size of cables</strong>.` : "";
}
</script>

</body>
</html>
