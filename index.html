<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cable Tray Visualizer</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    select, input { width: 100%; padding: 4px; }
    button { padding: 6px 12px; margin-top: 10px; }
    svg { border: 2px solid #333; background: #f4f4f4; margin-top: 20px; display: block; }
    .legend div { display: inline-block; margin-right: 10px; }
    .dot { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px; }
    .blue { background: #4A90E2; }
    .green { background: #4CAF50; }
  </style>
</head>
<body>

<h2>Tray Input</h2>
<label>Tray Width (mm): <input type="number" id="trayWidth" value="600" onchange="drawTray()" /></label><br>
<label>Tray Depth (mm): <input type="number" id="trayDepth" value="100" onchange="drawTray()" /></label><br>
<label>Insulation Level:
  <select id="insulationLevel" onchange="drawTray()">
    <option value="600">600V</option>
    <option value="1000">1000V</option>
  </select>
</label><br>
<label>Fill Ratio:
  <select id="fillRatio" onchange="drawTray()">
    <option value="0.4">40% (Recommended)</option>
    <option value="0.5">50%</option>
    <option value="0.6">60%</option>
  </select>
</label>

<h3>⚠️ Fill Ratio Legend</h3>
<table>
  <thead><tr><th>Fill %</th><th>Usage</th><th>Note</th></tr></thead>
  <tbody>
    <tr><td>40%</td><td>Power & Ground</td><td>Standard Safety</td></tr>
    <tr><td>50%</td><td>Control</td><td>Low ampacity only</td></tr>
    <tr><td>60%</td><td>Light load</td><td>Needs ventilation</td></tr>
  </tbody>
</table>

<h2>Results</h2>
<p id="totalArea">Total Cable Area: 0 mm²</p>
<p id="requiredArea">Required Tray Area: 0 mm²</p>
<p id="suggestedSize">Tray Status: OK</p>

<h2>Cable Input</h2>
<table id="cableTable">
  <thead>
    <tr>
      <th>Circuit #</th>
      <th>Type</th>
      <th>Line Size</th>
      <th>Qty</th>
      <th>Ground Size</th>
      <th>Qty</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<button onclick="addCableRow()">+ Add Cable Row</button>

<h2>Tray Visualizer</h2>
<svg id="traySvg"></svg>
<div class="legend">
  <div><span class="dot blue"></span>Line</div>
  <div><span class="dot green"></span>Ground</div>
</div>

<script>
const baseSingleCoreSizes = [
  { label: "12 AWG (3.31mm²)", area: 8.6, diameter: 3 },
  { label: "10 AWG (5.26mm²)", area: 13.2, diameter: 3.5 },
  { label: "8 AWG (8.37mm²)", area: 21.2, diameter: 4.5 },
  { label: "6 AWG (13.3mm²)", area: 34.6, diameter: 5.5 },
  { label: "4 AWG (21.2mm²)", area: 55.3, diameter: 6.5 },
  { label: "2 AWG (33.6mm²)", area: 85, diameter: 8.0 },
  { label: "1/0 AWG (53.5mm²)", area: 133, diameter: 10.0 },
  { label: "250 kcmil (127mm²)", area: 308, diameter: 15.0 },
  { label: "500 kcmil (253mm²)", area: 558, diameter: 20.0 },
  { label: "1000 kcmil (507mm²)", area: 1070, diameter: 30.0 }
];

const baseMultiCoreSizes = [
  { label: "2C 5.5mm² XLPE", area: 60, diameter: 12 },
  { label: "3C 5.5mm² XLPE", area: 80, diameter: 14 },
  { label: "4C 14mm² XLPE", area: 130, diameter: 17 },
  { label: "4C 60mm² XLPE", area: 250, diameter: 26 }
];

function adjustForVoltage(list, voltage) {
  const factor = voltage === 1000 ? 1.12 : 1; // 12% increase for 1000V
  return list.map(c => ({
    ...c,
    diameter: +(c.diameter * factor).toFixed(2),
    area: +(Math.PI * ((c.diameter * factor / 2) ** 2)).toFixed(2)
  }));
}

function getSizes(type) {
  const voltage = +document.getElementById("insulationLevel").value;
  return type === "Single Core"
    ? adjustForVoltage(baseSingleCoreSizes, voltage)
    : adjustForVoltage(baseMultiCoreSizes, voltage);
}

function createSizeOptions(type) {
  return getSizes(type).map((s, i) => `<option value="${i}">${s.label}</option>`).join('');
}

function createGroundSizeOptions() {
  const voltage = +document.getElementById("insulationLevel").value;
  return adjustForVoltage(baseSingleCoreSizes, voltage).map((s, i) => `<option value="${i}">${s.label}</option>`).join('');
}

function addCableRow() {
  const tbody = document.querySelector("#cableTable tbody");
  const index = tbody.rows.length + 1;
  const row = document.createElement("tr");
  row.innerHTML = `
    <td>${index}</td>
    <td><select onchange="updateDropdowns(this); drawTray()">
      <option>Single Core</option><option>Multicore</option></select></td>
    <td><select class="lineSize"></select></td>
    <td><input type="number" min="0" value="1" /></td>
    <td><select class="groundSize">${createGroundSizeOptions()}</select></td>
    <td><input type="number" min="0" value="0" /></td>
  `;
  tbody.appendChild(row);
  updateDropdowns(row.querySelector("select"));
  row.querySelectorAll("select, input").forEach(input => input.addEventListener("change", drawTray));
  drawTray();
}

function updateDropdowns(selectEl) {
  const row = selectEl.closest("tr");
  const type = selectEl.value;
  row.querySelector(".lineSize").innerHTML = createSizeOptions(type);
}

function drawTray() {
  const trayW = +document.getElementById("trayWidth").value;
  const trayH = +document.getElementById("trayDepth").value;
  const fillRatio = +document.getElementById("fillRatio").value;
  const svg = document.getElementById("traySvg");
  svg.setAttribute("viewBox", `0 0 ${trayW} ${trayH}`);
  svg.setAttribute("width", trayW * 2);
  svg.setAttribute("height", trayH * 2);
  svg.innerHTML = `<rect x="0" y="0" width="${trayW}" height="${trayH}" fill="#fff" stroke="#000"/>`;

  let cables = [], totalArea = 0;
  document.querySelectorAll("#cableTable tbody tr").forEach(row => {
    const type = row.cells[1].querySelector("select").value;
    const lineIdx = +row.cells[2].querySelector("select").value;
    const lineQty = +row.cells[3].querySelector("input").value;
    const groundIdx = +row.cells[4].querySelector("select").value;
    const groundQty = +row.cells[5].querySelector("input").value;
    const line = getSizes(type)[lineIdx];
    const ground = getSizes("Single Core")[groundIdx];

    for (let i = 0; i < lineQty; i++) {
      cables.push({ ...line, type, color: "#4A90E2" });
      totalArea += line.area;
    }
    for (let i = 0; i < groundQty; i++) {
      cables.push({ ...ground, type: "Single Core", color: "#4CAF50" });
      totalArea += ground.area;
    }
  });

  const required = totalArea / fillRatio;
  const trayArea = trayW * trayH;
  document.getElementById("totalArea").innerText = `Total Cable Area: ${totalArea.toFixed(2)} mm²`;
  document.getElementById("requiredArea").innerText = `Required Tray Area: ${required.toFixed(2)} mm²`;
  document.getElementById("suggestedSize").innerText =
    trayArea >= required ? "Tray Status: OK" : "Tray Status: TOO SMALL";

  let x = 5, y = 5, spacing = 2;
  for (let c of cables) {
    const r = c.diameter / 2;
    if (x + r * 2 > trayW) {
      x = 5;
      y += r * 2 + spacing;
    }
    if (y + r * 2 <= trayH) {
      svg.innerHTML += `<circle cx="${x + r}" cy="${y + r}" r="${r}" fill="none" stroke="${c.color}" stroke-width="2"/>`;

      if (c.type === "Multicore") {
        const count = parseInt(c.label.split("C")[0]) || 3;
        const coreR = r / 3;
        for (let i = 0; i < count; i++) {
          const angle = (2 * Math.PI / count) * i;
          const cx = x + r + (r - coreR - 2) * Math.cos(angle);
          const cy = y + r + (r - coreR - 2) * Math.sin(angle);
          svg.innerHTML += `<circle cx="${cx}" cy="${cy}" r="${coreR}" fill="#cd7f32" />`;
        }
      } else {
        svg.innerHTML += `<circle cx="${x + r}" cy="${y + r}" r="${r / 2.5}" fill="#cd7f32" />`;
      }
      x += r * 2 + spacing;
    }
  }
}

addCableRow();
</script>

</body>
</html>
